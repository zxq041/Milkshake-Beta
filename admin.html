<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Milk ‚Äî Panel Administratora</title>
  <meta name="theme-color" content="#FF6A00"/>
  <link rel="icon" href="/favicon.png"/>

  <!-- PWA optional -->
  <link rel="manifest" href="/manifest.webmanifest"/>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root {
      --primary-color: #FF6A00;
      --secondary-color: #FF9100;
      --accent-color: #FFE0B2;
      --background-light: #FFF6EC;
      --background-dark: #22110A;
      --text-color-dark: #2B1300;
      --text-color-light: #FFFFFF;
      --gradient-bg: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      --shadow: 0px 10px 30px rgba(0, 0, 0, 0.12);
      --border-radius: 20px;
      --success-color: #16A34A;
      --error-color: #DC2626;
      --muted: #8a7c73;
      --glass: rgba(255,255,255,0.88);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      color: var(--text-color-dark);
      background: var(--background-light);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .container { max-width: 1280px; margin: 0 auto; padding: 0 25px; }

    /* Header */
    .header {
      position: sticky; top: 0; z-index: 10;
      background: rgba(255,246,236,0.9);
      backdrop-filter: blur(8px);
      padding: 14px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .navbar {
      display:flex; align-items:center; justify-content:space-between;
      gap: 16px;
    }
    .logo {
      display:flex; align-items:center; gap:12px; text-decoration:none;
      font-weight: 900; font-size: 1.4rem; color: var(--primary-color);
    }
    .logo img {
      width: 44px; height: 44px; border-radius:50%;
      box-shadow: var(--shadow);
    }
    .header-actions { display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .pill {
      padding: 8px 12px; border-radius:999px; font-weight:700;
      background:#fff; box-shadow: var(--shadow); font-size:0.9rem;
      display:flex; align-items:center; gap:8px;
    }

    /* Buttons */
    .btn {
      padding: 12px 18px; border-radius: 999px; font-weight: 700;
      border:none; cursor:pointer; display:inline-flex; align-items:center; gap:8px;
      transition: all .25s ease; text-decoration:none;
    }
    .btn-primary {
      background: var(--gradient-bg); color:#fff;
      box-shadow: 0 6px 18px rgba(255,106,0,0.45);
    }
    .btn-primary:hover { transform: translateY(-2px); }
    .btn-ghost {
      background:#fff; color: var(--text-color-dark);
      box-shadow: var(--shadow);
    }
    .btn-ghost:hover { transform: translateY(-2px); }
    .btn-danger {
      background: #fff; color: var(--error-color);
      box-shadow: var(--shadow);
      border: 2px solid rgba(220,38,38,0.15);
    }
    .btn-small{ padding:8px 12px; font-size:0.9rem; }

    /* Tabs */
    .tabs {
      display:flex; gap:8px; flex-wrap:wrap;
      margin: 18px 0 8px;
    }
    .tab-btn{
      padding: 10px 16px; border-radius:999px; font-weight:800;
      background:#fff; box-shadow: var(--shadow); border:none; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      transition:.2s ease;
    }
    .tab-btn.active{
      background: var(--gradient-bg); color:#fff;
      box-shadow: 0 8px 22px rgba(255,106,0,0.45);
      transform: translateY(-1px);
    }
    .tab-panel{ display:none; }
    .tab-panel.active{ display:block; }

    /* Layout */
    .grid {
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      padding: 10px 0 40px;
    }
    @media (max-width: 992px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* Cards / sections */
    .card {
      background: var(--glass);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.9);
    }
    .section-title {
      font-size: 1.2rem; font-weight: 900;
      margin-bottom: 12px;
      background: var(--gradient-bg);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .stat {
      display:flex; align-items:center; justify-content:space-between;
      padding:12px; border-radius:14px; background: #fff7ef; margin-bottom:10px;
      font-weight:700;
    }
    .stat small { font-weight:600; color: var(--muted); }
    .small { font-size:0.85rem; color: var(--muted); font-weight:600; }

    .content-header {
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px; margin-bottom: 12px;
      flex-wrap:wrap;
    }
    .content-header h2{
      font-size: clamp(1.6rem, 3vw, 2.2rem);
      font-weight: 900;
    }

    /* Lists */
    .list{ display:grid; gap:12px; }
    .item{
      border-radius: 16px; padding: 14px;
      background:#fff; box-shadow: var(--shadow);
      display:grid; grid-template-columns: 1fr auto; gap: 10px;
      border-left: 6px solid transparent;
    }
    .item .meta{
      display:flex; flex-wrap:wrap; gap: 8px 12px; font-size:0.95rem;
    }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      background:#fff6ec; padding:6px 10px; border-radius:999px;
      font-weight:700; font-size:0.85rem;
    }
    .actions{
      display:flex; flex-direction:column; gap:8px; align-items:flex-end;
      min-width: 160px;
    }
    @media (max-width:768px){
      .actions{ flex-direction:row; min-width:0; flex-wrap:wrap; justify-content:flex-end; }
      .actions .btn{ flex:1 1 auto; justify-content:center; }
    }

    /* Forms */
    .input{
      width:100%;
      padding: 12px 14px;
      border:2px solid #eee;
      border-radius:12px;
      font-family:'Poppins',sans-serif;
      font-size:1rem;
      outline:none;
      transition:.2s ease;
      background:#fff;
    }
    .input:focus{
      border-color: var(--primary-color);
      box-shadow: 0 6px 18px rgba(255,106,0,0.08);
    }
    label .small{ display:block; margin-bottom:4px; }

    .row{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    @media (max-width:560px){
      .row{ grid-template-columns:1fr; }
    }

    /* Empty */
    .empty {
      text-align:center; padding: 30px 12px; color: var(--muted);
      font-weight:700; background:#fff; border-radius:16px; box-shadow: var(--shadow);
    }

    /* Lockscreen */
    .lockscreen{
      position: fixed; inset:0; z-index: 999;
      background: radial-gradient(1200px circle at top, #fff 0%, #fff2e5 40%, #ffe9d5 100%);
      display:flex; align-items:center; justify-content:center;
      padding: 20px;
    }
    .lock-card{
      width:min(520px, 100%);
      background:#fff; border-radius: 24px; box-shadow: var(--shadow);
      padding: 26px;
      text-align:center;
    }
    .lock-card .logo-big{
      display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:12px;
      font-size:1.6rem; font-weight:900; color: var(--primary-color);
    }
    .lock-card img{ width:64px; height:64px; border-radius:50%; }
    .lock-card p{ color: var(--muted); margin-bottom:14px; }
    .code-input{
      display:flex; gap: 8px; justify-content:center; margin: 10px 0 16px;
    }
    .code-input input{
      width: 56px; height: 62px; text-align:center; font-size:1.6rem; font-weight:900;
      border:2px solid #eee; border-radius:12px; outline:none;
      transition: .2s ease;
    }
    .code-input input:focus{ border-color: var(--primary-color); box-shadow: 0 6px 18px rgba(255,106,0,0.12); }
    .lock-error{ color: var(--error-color); font-weight:800; min-height: 1.2em; }

    /* Toast */
    .toast {
      position: fixed; bottom: 18px; right: 18px; z-index: 9999;
      background: var(--success-color); color:#fff; font-weight:800;
      padding: 12px 16px; border-radius: 999px; box-shadow: 0 10px 25px rgba(0,0,0,.25);
      display:flex; align-items:center; gap:8px; opacity:0; transform: translateY(8px);
      transition: .25s ease; pointer-events:none;
    }
    .toast.visible { opacity:1; transform: translateY(0); }
    .toast.error { background: var(--error-color); }

    /* Status pills */
    .status{
      font-weight:900; padding:4px 8px; border-radius:999px; font-size:0.8rem;
      background:#fff3e6; color:#8a3d00; display:inline-flex; gap:6px; align-items:center;
    }
    .status.ok{ background:#e9fff1; color:#0f7a3a; }
    .status.warn{ background:#fff7e6; color:#8a5b00; }
    .status.bad{ background:#ffe8e8; color:#a10202; }

    /* Search bar */
    .search{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .search input{ flex:1 1 260px; }

  </style>
</head>

<body>

  <!-- LOCKSCREEN -->
  <div class="lockscreen" id="lockscreen" aria-live="polite">
    <div class="lock-card">
      <div class="logo-big">
        <img src="https://i.imgur.com/Twr2Rms.jpeg" alt="MilkShake Bar">
        <span>Milk ‚Äî Admin</span>
      </div>
      <p>Wpisz kod dostƒôpu (pracownika), aby przej≈õƒá do panelu Milk.</p>

      <div class="code-input" id="codeInput">
        <input inputmode="numeric" maxlength="1" aria-label="cyfra 1">
        <input inputmode="numeric" maxlength="1" aria-label="cyfra 2">
        <input inputmode="numeric" maxlength="1" aria-label="cyfra 3">
        <input inputmode="numeric" maxlength="1" aria-label="cyfra 4">
      </div>

      <div class="lock-error" id="lockError"></div>

      <button class="btn btn-primary" id="unlockBtn">
        Zaloguj <i class="fas fa-unlock"></i>
      </button>
    </div>
  </div>

  <!-- HEADER -->
  <header class="header">
    <div class="container">
      <nav class="navbar">
        <a class="logo" href="/admin-milk.html">
          <img src="https://i.imgur.com/UNPIPSC.png" alt="Logo">
          <span>Milk ‚Äî Panel</span>
        </a>

        <div class="header-actions">
          <div class="pill">
            <i class="fa-solid fa-circle" id="liveDot" style="color:#16A34A"></i>
            <span id="liveText">LIVE</span>
          </div>

          <button class="btn btn-ghost" id="refreshBtn">
            <i class="fa-solid fa-rotate"></i> Od≈õwie≈º wszystko
          </button>

          <div class="pill" id="whoamiPill">
            <i class="fa-solid fa-user"></i>
            <span id="whoamiText">‚Äî</span>
          </div>
        </div>
      </nav>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="tab-dashboard">
          <i class="fa-solid fa-chart-line"></i> Dashboard
        </button>

        <button class="tab-btn" data-tab="tab-users">
          <i class="fa-solid fa-users"></i> U≈ºytkownicy & Punkty
        </button>

        <button class="tab-btn" data-tab="tab-rewards">
          <i class="fa-solid fa-gift"></i> Nagrody
        </button>

        <button class="tab-btn" data-tab="tab-orders">
          <i class="fa-solid fa-bag-shopping"></i> Zam√≥wienia
        </button>

        <button class="tab-btn" data-tab="tab-prepaid">
          <i class="fa-solid fa-credit-card"></i> Karty Pre-Paid
        </button>

        <button class="tab-btn" data-tab="tab-prepaid-actions">
          <i class="fa-solid fa-wallet"></i> Akcje na karcie
        </button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container">
    <div class="grid">

      <!-- SIDEBAR -->
      <aside class="sidebar card">
        <div class="section-title">Statystyki Milk</div>

        <div class="stat">
          <div>U≈ºytkownicy<br><small>≈ÇƒÖcznie</small></div>
          <div id="statUsers">0</div>
        </div>

        <div class="stat">
          <div>Punkty<br><small>suma</small></div>
          <div id="statPoints">0</div>
        </div>

        <div class="stat">
          <div>Wymiany nagr√≥d<br><small>≈ÇƒÖcznie</small></div>
          <div id="statRedeems">0</div>
        </div>

        <div class="stat">
          <div>Zam√≥wienia<br><small>aktywne</small></div>
          <div id="statOrdersActive">0</div>
        </div>

        <div class="stat">
          <div>Karty Pre-Paid<br><small>aktywne</small></div>
          <div id="statPrepaidActive">0</div>
        </div>

        <p class="small" style="margin-top:12px;line-height:1.5">
          Panel Milk korzysta z API Twojego serwera.  
          Realtime dzia≈Ça przez Socket.IO je≈õli wy≈õlesz eventy.
        </p>
      </aside>

      <!-- CONTENT -->
      <section>

        <!-- DASHBOARD -->
        <div class="tab-panel active" id="tab-dashboard">
          <div class="content-header">
            <h2>Dashboard</h2>
            <div class="small" id="lastSync">Ostatnia synchronizacja: ‚Äî</div>
          </div>

          <div class="list" id="dashFeed">
            <div class="empty">≈Åadujƒô dashboard...</div>
          </div>
        </div>

        <!-- USERS & POINTS -->
        <div class="tab-panel" id="tab-users">
          <div class="content-header">
            <h2>U≈ºytkownicy & Punkty</h2>
            <div class="search">
              <input class="input" id="userSearch" placeholder="Szukaj po ID / nazwie / emailu">
              <button class="btn btn-ghost btn-small" id="userSearchBtn">
                <i class="fa-solid fa-magnifying-glass"></i> Szukaj
              </button>
            </div>
          </div>

          <div class="card" style="margin-bottom:12px;">
            <div class="section-title">Dodaj punkty (10 z≈Ç = 1 pkt)</div>
            <form id="addPointsForm" class="row">
              <label>
                <span class="small">ID klienta</span>
                <input class="input" name="userId" required placeholder="np. 2f8a-91ab...">
              </label>
              <label>
                <span class="small">Kwota wydana (z≈Ç)</span>
                <input class="input" name="amount" type="number" min="0" step="0.01" required placeholder="np. 50">
              </label>
              <div style="grid-column:1/-1; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
                <div class="small" id="pointsPreview">Punkty do dodania: ‚Äî</div>
                <button class="btn btn-primary">
                  <i class="fa-solid fa-coins"></i> Dodaj punkty
                </button>
              </div>
            </form>
          </div>

          <div class="list" id="usersList">
            <div class="empty">≈Åadujƒô u≈ºytkownik√≥w...</div>
          </div>
        </div>

        <!-- REWARDS -->
        <div class="tab-panel" id="tab-rewards">
          <div class="content-header">
            <h2>Nagrody</h2>
          </div>

          <div class="grid" style="grid-template-columns:360px 1fr; padding-top:0;">
            <div class="card">
              <div class="section-title">Dodaj nagrodƒô</div>
              <form id="addRewardForm" style="display:grid; gap:10px;">
                <label>
                  <span class="small">Nazwa nagrody</span>
                  <input class="input" name="title" required placeholder="np. Voucher 100 z≈Ç">
                </label>
                <label>
                  <span class="small">Koszt (pkt)</span>
                  <input class="input" name="cost" type="number" min="1" step="1" required placeholder="np. 120">
                </label>
                <label>
                  <span class="small">Opis (opcjonalnie)</span>
                  <textarea class="input" name="desc" placeholder="Opis nagrody"></textarea>
                </label>
                <button class="btn btn-primary" type="submit">
                  <i class="fa-solid fa-gift"></i> Dodaj
                </button>
                <div class="small" id="rewardHint"></div>
              </form>
            </div>

            <div class="card">
              <div class="section-title">Lista nagr√≥d</div>
              <div class="list" id="rewardsList">
                <div class="empty">≈Åadujƒô nagrody...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ORDERS -->
        <div class="tab-panel" id="tab-orders">
          <div class="content-header">
            <h2>Zam√≥wienia do odbioru</h2>
            <div class="small">Zmiana statusu pojawia siƒô u klienta.</div>
          </div>

          <div class="list" id="ordersList">
            <div class="empty">≈Åadujƒô zam√≥wienia...</div>
          </div>
        </div>

        <!-- PREPAID -->
        <div class="tab-panel" id="tab-prepaid">
          <div class="content-header">
            <h2>Karty Pre-Paid</h2>
            <div class="small">PodglƒÖd zakupionych kart.</div>
          </div>

          <div class="list" id="prepaidList">
            <div class="empty">≈Åadujƒô karty...</div>
          </div>
        </div>

        <!-- PREPAID ACTIONS -->
        <div class="tab-panel" id="tab-prepaid-actions">
          <div class="content-header">
            <h2>Akcje na karcie Pre-Paid</h2>
            <div class="small">Wpisz kod z karty klienta</div>
          </div>

          <div class="card">
            <form id="prepaidAdjustForm" style="display:grid; gap:10px;">
              <label>
                <span class="small">Kod karty</span>
                <input class="input" name="code" required placeholder="np. 123456">
              </label>

              <div class="row">
                <label>
                  <span class="small">Kwota (z≈Ç)</span>
                  <input class="input" name="amount" type="number" step="0.01" min="0" required placeholder="np. 20">
                </label>
                <label>
                  <span class="small">Akcja</span>
                  <select class="input" name="action" required>
                    <option value="add">Do≈Çaduj</option>
                    <option value="subtract">Odejmij</option>
                  </select>
                </label>
              </div>

              <label>
                <span class="small">Notatka (opcjonalnie)</span>
                <textarea class="input" name="note" placeholder="np. dop≈Çata w lokalu"></textarea>
              </label>

              <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
                <button class="btn btn-primary">
                  <i class="fa-solid fa-wallet"></i> Zatwierd≈∫
                </button>
              </div>

              <div class="small" id="prepaidAdjustResult"></div>
            </form>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="section-title">Szczeg√≥≈Çy karty</div>
            <div id="prepaidDetails" class="small">Wpisz kod, aby zobaczyƒá szczeg√≥≈Çy.</div>
          </div>
        </div>

      </section>

    </div>
  </main>

  <!-- toast -->
  <div class="toast" id="toast">
    <i class="fa-solid fa-bell"></i>
    <span id="toastText">OK</span>
  </div>

  <!-- socket.io -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // =========================
    //  API map (zmie≈Ñ je≈õli masz inne ≈õcie≈ºki)
    // =========================
    const API = {
      login:        "/api/login",

      stats:        "/api/milk/stats",

      users:        "/api/milk/users",
      userById:     id => `/api/milk/users/${id}`,
      addPoints:    "/api/milk/points/add",

      rewards:      "/api/milk/rewards",
      rewardDel:    id => `/api/milk/rewards/${id}`,

      orders:       "/api/milk/orders",
      orderStatus:  id => `/api/milk/orders/${id}/status`,

      prepaid:      "/api/milk/prepaid",
      prepaidByCode:code => `/api/milk/prepaid/code/${encodeURIComponent(code)}`,
      prepaidAdjust:"/api/milk/prepaid/adjust"
    };

    // =========================
    //  Helpers
    // =========================
    const toast = document.getElementById("toast");
    const toastText = document.getElementById("toastText");
    function showToast(msg, isError=false){
      toastText.textContent = msg;
      toast.classList.toggle("error", isError);
      toast.classList.add("visible");
      setTimeout(()=>toast.classList.remove("visible"), 3500);
    }

    async function jfetch(url, opts={}){
      const res = await fetch(url, { cache:"no-store", ...opts });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok) throw new Error(data?.message || res.status);
      return data;
    }

    function fmtPLN(n){
      const v = Number(n||0);
      return v.toLocaleString("pl-PL",{minimumFractionDigits:2, maximumFractionDigits:2}) + " z≈Ç";
    }

    function statusBadge(s){
      const map = {
        "Przyjƒôte":"ok",
        "W przygotowaniu":"warn",
        "Gotowe do odbioru":"warn",
        "Wydane":"ok",
        "Anulowane":"bad"
      };
      return `<span class="status ${map[s]||""}"><i class="fa-solid fa-circle"></i> ${s||"‚Äî"}</span>`;
    }

    // =========================
    //  Tabs
    // =========================
    const tabBtns = document.querySelectorAll(".tab-btn[data-tab]");
    const tabPanels = document.querySelectorAll(".tab-panel");
    tabBtns.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        tabBtns.forEach(b=>b.classList.remove("active"));
        tabPanels.forEach(p=>p.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
        window.scrollTo({top:0, behavior:"smooth"});
      });
    });

    // =========================
    //  Lock screen (API login)
    // =========================
    const lockscreen = document.getElementById("lockscreen");
    const lockError = document.getElementById("lockError");
    const unlockBtn = document.getElementById("unlockBtn");
    const codeBoxes = [...document.querySelectorAll("#codeInput input")];

    let currentRole = null;
    let currentEmployee = null;

    function getTypedPin(){ return codeBoxes.map(b => b.value.trim()).join(""); }
    function clearPin(){
      codeBoxes.forEach(b => b.value="");
      codeBoxes[0].focus();
    }

    async function tryUnlock(){
      const typed = getTypedPin();
      if(typed.length !== 4) return;

      try{
        const res = await fetch(API.login, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ pin: typed })
        });
        const data = await res.json().catch(()=> ({}));
        if(!res.ok || !data.ok){
          lockError.textContent = data.message || "Niepoprawny kod.";
          clearPin();
          return;
        }

        currentRole = data.role;
        currentEmployee = data.user || null;

        document.getElementById("whoamiText").textContent =
          (currentEmployee?.name || "Konto") + " ‚Ä¢ " + (currentRole||"‚Äî");

        lockscreen.style.display = "none";
        showToast(`Zalogowano: ${currentEmployee?.name || "OK"} ‚úÖ`);

        boot();
      }catch(e){
        console.error(e);
        lockError.textContent = "B≈ÇƒÖd logowania (sieƒá).";
        clearPin();
      }
    }

    unlockBtn.addEventListener("click", tryUnlock);
    codeBoxes.forEach((box, i) => {
      box.addEventListener("input", ()=>{
        lockError.textContent = "";
        box.value = box.value.replace(/\D/g,"").slice(0,1);
        if(box.value && codeBoxes[i+1]) codeBoxes[i+1].focus();
        if(getTypedPin().length === 4) tryUnlock();
      });
      box.addEventListener("keydown",(e)=>{
        if(e.key==="Backspace" && !box.value && codeBoxes[i-1]) codeBoxes[i-1].focus();
      });
    });
    clearPin();

    // =========================
    //  Data + renderers
    // =========================
    const statUsers = document.getElementById("statUsers");
    const statPoints = document.getElementById("statPoints");
    const statRedeems = document.getElementById("statRedeems");
    const statOrdersActive = document.getElementById("statOrdersActive");
    const statPrepaidActive = document.getElementById("statPrepaidActive");
    const lastSync = document.getElementById("lastSync");

    const dashFeed = document.getElementById("dashFeed");
    const usersList = document.getElementById("usersList");
    const rewardsList = document.getElementById("rewardsList");
    const ordersList = document.getElementById("ordersList");
    const prepaidList = document.getElementById("prepaidList");

    let users = [];
    let rewards = [];
    let orders = [];
    let prepaid = [];

    async function loadStats(){
      const s = await jfetch(API.stats);
      statUsers.textContent = s.users ?? 0;
      statPoints.textContent = s.pointsTotal ?? 0;
      statRedeems.textContent = s.redeems ?? 0;
      statOrdersActive.textContent = s.ordersActive ?? 0;
      statPrepaidActive.textContent = s.prepaidActive ?? 0;
    }

    // ----- USERS -----
    function userCardHTML(u){
      return `
        <article class="item" data-id="${u.id}">
          <div>
            <div style="font-size:1.1rem;font-weight:900;margin-bottom:6px">
              ${u.username || u.name || "U≈ºytkownik"}
            </div>
            <div class="meta">
              <span class="tag"><i class="fa-solid fa-id-card"></i> ID: ${u.id}</span>
              <span class="tag"><i class="fa-solid fa-coins"></i> ${u.points||0} pkt</span>
              ${u.email ? `<span class="tag"><i class="fa-solid fa-envelope"></i> ${u.email}</span>`:""}
              ${u.phone ? `<span class="tag"><i class="fa-solid fa-phone"></i> ${u.phone}</span>`:""}
            </div>
            <div class="small" style="margin-top:6px">
              Ostatnia aktywno≈õƒá: ${u.updatedAt ? new Date(u.updatedAt).toLocaleString() : "‚Äî"}
            </div>
          </div>

          <div class="actions">
            <button class="btn btn-ghost btn-small view-user-btn">
              <i class="fa-solid fa-eye"></i> Szczeg√≥≈Çy
            </button>
          </div>
        </article>
      `;
    }

    async function loadUsers(q=""){
      const url = q ? (API.users + "?q=" + encodeURIComponent(q)) : API.users;
      users = await jfetch(url);
      renderUsers();
    }

    function renderUsers(){
      if(!users.length){
        usersList.innerHTML = `<div class="empty">Brak u≈ºytkownik√≥w.</div>`;
        return;
      }
      usersList.innerHTML = users.map(userCardHTML).join("");
      usersList.querySelectorAll(".view-user-btn").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.closest(".item").dataset.id;
          try{
            const detail = await jfetch(API.userById(id));
            alert(
              `U≈ºytkownik: ${detail.username||detail.name||id}\n`+
              `Punkty: ${detail.points||0}\n`+
              `Wymiany: ${detail.redeems?.length||0}\n`+
              `Zam√≥wienia: ${detail.orders?.length||0}\n`+
              `Karty: ${detail.prepaid?.length||0}`
            );
          }catch(e){
            showToast("Nie uda≈Ço siƒô pobraƒá szczeg√≥≈Ç√≥w", true);
          }
        });
      });
    }

    // ----- REWARDS -----
    function rewardCardHTML(r){
      return `
        <article class="item" data-id="${r.id || r._id}">
          <div>
            <div style="font-size:1.05rem;font-weight:900;margin-bottom:6px">
              ${r.title}
            </div>
            <div class="meta">
              <span class="tag"><i class="fa-solid fa-coins"></i> ${r.cost} pkt</span>
              ${r.desc ? `<span class="tag"><i class="fa-regular fa-note-sticky"></i> ${r.desc}</span>` : ""}
            </div>
            <div class="small" style="margin-top:6px">
              ID: ${r.id || r._id}
            </div>
          </div>

          <div class="actions">
            <button class="btn btn-danger btn-small del-reward-btn">
              <i class="fa-solid fa-trash"></i> Usu≈Ñ
            </button>
          </div>
        </article>
      `;
    }

    async function loadRewards(){
      rewards = await jfetch(API.rewards);
      renderRewards();
    }
    function renderRewards(){
      if(!rewards.length){
        rewardsList.innerHTML = `<div class="empty">Brak nagr√≥d.</div>`;
        return;
      }
      rewardsList.innerHTML = rewards.map(rewardCardHTML).join("");
      rewardsList.querySelectorAll(".del-reward-btn").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.closest(".item").dataset.id;
          if(!confirm("UsunƒÖƒá nagrodƒô?")) return;
          try{
            await jfetch(API.rewardDel(id), { method:"DELETE" });
            showToast("Usuniƒôto nagrodƒô ‚úÖ");
            loadRewards(); loadStats();
          }catch(e){
            showToast("Nie uda≈Ço siƒô usunƒÖƒá", true);
          }
        });
      });
    }

    // ----- ORDERS -----
    function orderCardHTML(o){
      const items = (o.items||[]).map(i=>`‚Ä¢ ${i.qty}x ${i.title}`).join("<br>");
      return `
        <article class="item" data-id="${o.id}">
          <div>
            <div style="font-size:1.05rem;font-weight:900;margin-bottom:6px">
              ${o.pickupLocation || "S≈Çupsk"} ‚Ä¢ ${o.pickupTime || "‚Äî"}
            </div>
            <div class="meta">
              ${statusBadge(o.status)}
              <span class="tag"><i class="fa-solid fa-receipt"></i> ${fmtPLN(o.total)}</span>
              <span class="tag"><i class="fa-regular fa-clock"></i> ${o.date ? new Date(o.date).toLocaleString() : "‚Äî"}</span>
              ${o.userId ? `<span class="tag"><i class="fa-solid fa-id-card"></i> ${o.userId}</span>`:""}
            </div>
            <div style="margin-top:6px; line-height:1.5">${items || "‚Äî"}</div>
            ${o.notes ? `<div class="small" style="margin-top:6px">Uwagi: ${o.notes}</div>`:""}
          </div>

          <div class="actions">
            <select class="input order-status-select">
              ${["Przyjƒôte","W przygotowaniu","Gotowe do odbioru","Wydane","Anulowane"]
                .map(s=>`<option ${s===o.status?"selected":""}>${s}</option>`).join("")}
            </select>
            <button class="btn btn-primary btn-small save-order-status">
              <i class="fa-solid fa-save"></i> Zapisz
            </button>
          </div>
        </article>
      `;
    }

    async function loadOrders(){
      orders = await jfetch(API.orders);
      renderOrders();
    }
    function renderOrders(){
      if(!orders.length){
        ordersList.innerHTML = `<div class="empty">Brak zam√≥wie≈Ñ.</div>`;
        return;
      }
      ordersList.innerHTML = orders.map(orderCardHTML).join("");
      ordersList.querySelectorAll(".save-order-status").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const card = btn.closest(".item");
          const id = card.dataset.id;
          const status = card.querySelector(".order-status-select").value;
          try{
            await jfetch(API.orderStatus(id), {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ status })
            });
            showToast("Zmieniono status ‚úÖ");
            loadOrders(); loadStats();
          }catch(e){
            showToast("Nie uda≈Ço siƒô zmieniƒá statusu", true);
          }
        });
      });
    }

    // ----- PREPAID LIST -----
    function prepaidCardHTML(p){
      return `
        <article class="item" data-code="${p.code}">
          <div>
            <div style="font-size:1.05rem;font-weight:900;margin-bottom:6px">
              ${p.title || "Karta Pre-Paid"}
            </div>
            <div class="meta">
              <span class="tag"><i class="fa-solid fa-ticket"></i> Kod: ${p.code}</span>
              <span class="tag"><i class="fa-solid fa-wallet"></i> Saldo: ${fmtPLN(p.balance ?? p.total ?? 0)}</span>
              <span class="tag"><i class="fa-regular fa-calendar"></i> ${p.date ? new Date(p.date).toLocaleString() : "‚Äî"}</span>
              ${p.userId ? `<span class="tag"><i class="fa-solid fa-id-card"></i> ${p.userId}</span>`:""}
              <span class="tag"><i class="fa-solid fa-circle"></i> ${p.used ? "U≈ºyta" : "Aktywna"}</span>
            </div>
            ${p.note ? `<div class="small" style="margin-top:6px">Notatka: ${p.note}</div>`:""}
          </div>

          <div class="actions">
            <button class="btn btn-ghost btn-small go-prepaid-actions">
              <i class="fa-solid fa-wallet"></i> Akcje
            </button>
          </div>
        </article>
      `;
    }

    async function loadPrepaid(){
      prepaid = await jfetch(API.prepaid);
      renderPrepaid();
    }
    function renderPrepaid(){
      if(!prepaid.length){
        prepaidList.innerHTML = `<div class="empty">Brak kart.</div>`;
        return;
      }
      prepaidList.innerHTML = prepaid.map(prepaidCardHTML).join("");
      prepaidList.querySelectorAll(".go-prepaid-actions").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const code = btn.closest(".item").dataset.code;
          document.querySelector('[data-tab="tab-prepaid-actions"]').click();
          document.querySelector('#prepaidAdjustForm [name="code"]').value = code;
          fetchPrepaidDetails(code);
        });
      });
    }

    // =========================
    //  Actions
    // =========================

    // Add points form
    const addPointsForm = document.getElementById("addPointsForm");
    const pointsPreview = document.getElementById("pointsPreview");
    addPointsForm.elements.amount.addEventListener("input", ()=>{
      const amount = parseFloat(addPointsForm.elements.amount.value || "0");
      const pts = Math.floor(amount / 10);
      pointsPreview.textContent = `Punkty do dodania: ${pts}`;
    });

    addPointsForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const fd = new FormData(addPointsForm);
      const userId = String(fd.get("userId")||"").trim();
      const amount = parseFloat(fd.get("amount")||"0");
      const points = Math.floor(amount / 10);

      if(!points){
        showToast("Kwota za ma≈Ça (min. 10 z≈Ç)", true);
        return;
      }

      try{
        await jfetch(API.addPoints, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ userId, amount, points })
        });
        showToast(`Dodano ${points} pkt ‚úÖ`);
        addPointsForm.reset();
        pointsPreview.textContent = "Punkty do dodania: ‚Äî";
        loadUsers(); loadStats();
      }catch(e){
        showToast("Nie uda≈Ço siƒô dodaƒá punkt√≥w", true);
      }
    });

    // Search users
    document.getElementById("userSearchBtn").addEventListener("click", ()=>{
      const q = document.getElementById("userSearch").value.trim();
      loadUsers(q);
    });

    // Add reward
    const addRewardForm = document.getElementById("addRewardForm");
    const rewardHint = document.getElementById("rewardHint");
    addRewardForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      rewardHint.textContent = "";
      const fd = new FormData(addRewardForm);
      const payload = {
        title: String(fd.get("title")||"").trim(),
        cost: parseInt(fd.get("cost")||"0",10),
        desc: String(fd.get("desc")||"").trim()
      };
      try{
        await jfetch(API.rewards, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        showToast("Dodano nagrodƒô ‚úÖ");
        addRewardForm.reset();
        loadRewards(); loadStats();
      }catch(e){
        rewardHint.textContent = "B≈ÇƒÖd dodania nagrody.";
        showToast("Nie uda≈Ço siƒô dodaƒá nagrody", true);
      }
    });

    // Prepaid adjust
    const prepaidAdjustForm = document.getElementById("prepaidAdjustForm");
    const prepaidAdjustResult = document.getElementById("prepaidAdjustResult");
    const prepaidDetails = document.getElementById("prepaidDetails");

    async function fetchPrepaidDetails(code){
      prepaidDetails.textContent = "≈Åadujƒô szczeg√≥≈Çy...";
      try{
        const p = await jfetch(API.prepaidByCode(code));
        prepaidDetails.innerHTML = `
          <div class="stat"><div>Kod</div><div>${p.code}</div></div>
          <div class="stat"><div>Saldo</div><div>${fmtPLN(p.balance ?? p.total ?? 0)}</div></div>
          <div class="stat"><div>Status</div><div>${p.used ? "U≈ºyta" : "Aktywna"}</div></div>
          ${p.userId ? `<div class="small">U≈ºytkownik: ${p.userId}</div>`:""}
        `;
      }catch(e){
        prepaidDetails.textContent = "Nie znaleziono karty.";
      }
    }

    prepaidAdjustForm.elements.code.addEventListener("input", ()=>{
      const code = prepaidAdjustForm.elements.code.value.trim();
      if(code.length >= 4) fetchPrepaidDetails(code);
    });

    prepaidAdjustForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      prepaidAdjustResult.textContent = "Przetwarzam...";
      const fd = new FormData(prepaidAdjustForm);
      const payload = {
        code: String(fd.get("code")||"").trim(),
        amount: parseFloat(fd.get("amount")||"0"),
        action: String(fd.get("action")||"add"),
        note: String(fd.get("note")||"").trim()
      };

      if(!payload.code || !payload.amount){
        prepaidAdjustResult.textContent = "Wpisz kod i kwotƒô.";
        return;
      }

      try{
        const out = await jfetch(API.prepaidAdjust, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        prepaidAdjustResult.innerHTML = `
          ‚úÖ OK. Nowe saldo: <b>${fmtPLN(out.balance)}</b>
        `;
        showToast("Zapisano zmianƒô ‚úÖ");
        fetchPrepaidDetails(payload.code);
        loadPrepaid(); loadStats();
      }catch(e){
        prepaidAdjustResult.textContent = "B≈ÇƒÖd operacji.";
        showToast("Nie uda≈Ço siƒô wykonaƒá operacji", true);
      }
    });

    // Refresh all
    document.getElementById("refreshBtn").addEventListener("click", ()=>{
      refreshAll(true);
    });

    // Dashboard feed
    function renderDashboard(){
      const feed = [];

      // newest orders
      const newestOrders = orders.slice(0,4).map(o=>({
        type:"order",
        title:`Zam√≥wienie: ${o.pickupLocation||"S≈Çupsk"} ‚Ä¢ ${o.pickupTime||"‚Äî"}`,
        sub:`${fmtPLN(o.total)} ‚Ä¢ ${o.status||"Przyjƒôte"}`,
        time:o.date
      }));
      feed.push(...newestOrders);

      // newest prepaid
      const newestPrepaid = prepaid.slice(0,4).map(p=>({
        type:"prepaid",
        title:`Karta: ${p.title||"Pre-Paid"} ‚Ä¢ ${fmtPLN(p.balance ?? p.total ?? 0)}`,
        sub:`Kod ${p.code} ‚Ä¢ ${p.used?"U≈ºyta":"Aktywna"}`,
        time:p.date
      }));
      feed.push(...newestPrepaid);

      if(!feed.length){
        dashFeed.innerHTML = `<div class="empty">Brak zdarze≈Ñ.</div>`;
        return;
      }

      dashFeed.innerHTML = feed
        .sort((a,b)=> new Date(b.time||0)-new Date(a.time||0))
        .map(f=>`
          <article class="item">
            <div>
              <div style="font-weight:900; font-size:1.05rem;">${f.title}</div>
              <div class="small">${f.sub}</div>
              <div class="tiny">${f.time ? new Date(f.time).toLocaleString() : "‚Äî"}</div>
            </div>
            <div class="actions">
              <span class="status ${f.type==="order"?"warn":"ok"}">
                ${f.type==="order" ? "Zam√≥wienie" : "Pre-Paid"}
              </span>
            </div>
          </article>
        `).join("");
    }

    async function refreshAll(silent=false){
      try{
        await Promise.all([loadStats(), loadUsers(), loadRewards(), loadOrders(), loadPrepaid()]);
        renderDashboard();
        lastSync.textContent = "Ostatnia synchronizacja: " + new Date().toLocaleString();
        if(!silent) showToast("Od≈õwie≈ºono ‚úÖ");
      }catch(e){
        console.error(e);
        if(!silent) showToast("B≈ÇƒÖd od≈õwie≈ºania", true);
      }
    }

    // =========================
    //  Realtime (optional)
    // =========================
    try{
      if(window.io){
        const socket = io();

        socket.on("connect", ()=> {
          document.getElementById("liveText").textContent = "LIVE";
          document.getElementById("liveDot").style.color = "#16A34A";
        });
        socket.on("disconnect", ()=> {
          document.getElementById("liveText").textContent = "OFFLINE";
          document.getElementById("liveDot").style.color = "#DC2626";
        });

        socket.on("milk:order:new", (o)=>{
          showToast("Nowe zam√≥wienie üîî");
          orders.unshift(o); renderOrders(); renderDashboard(); loadStats();
        });
        socket.on("milk:prepaid:new", (p)=>{
          showToast("Nowa karta Pre-Paid üí≥");
          prepaid.unshift(p); renderPrepaid(); renderDashboard(); loadStats();
        });
        socket.on("milk:users:update", ()=>{
          loadUsers(); loadStats();
        });
      }
    }catch(e){}

    function boot(){
      refreshAll(true);
      setInterval(()=>refreshAll(true), 7000);
    }
  </script>
</body>
</html>
